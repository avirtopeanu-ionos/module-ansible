- hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars.yml

  tasks:
    - name: Create datacenter
      datacenter:
        name: "{{ datacenter }}"
        location: "{{ location }}"
        wait: true

    - name: Provision server
      server:
        datacenter: "{{ datacenter }}"
        name: "{{ server }}"
        auto_increment: false
        cores: 1
        ram: 2048
        volume_size: 5
        image: "{{ image }}"
        image_password: "{{ password }}"
        location: "{{ location }}"
        assign_public_ip: true
        remove_boot_volume: true
        wait: true
        wait_timeout: "{{ timeout }}"
        state: present
      register: ionos_cloud

    - name: Create public LAN
      lan:
        datacenter: "{{ datacenter }}"
        name: "{{ lan }}"
        public: true
      register: ionos_cloud_lan

    - name: Create NIC
      nic:
        name: "{{ name }}"
        datacenter: "{{ datacenter }}"
        server: "{{ server }}"
        lan: "{{ ionos_cloud_lan.lan.id }}"
        firewall_active: true
        wait: true
        wait_timeout: "{{ timeout }}"
        state: present
      register: ionos_cloud_nic

    - name: Update NIC
      nic:
        datacenter: "{{ datacenter }}"
        server: "{{ server }}"
        name: "{{ name }}"
        dhcp: false
        ips: "158.222.102.93"
        state: update

    - name: Update LAN
      lan:
        datacenter: "{{ name }}"
        name: "{{ lan }}"
        ip_failover:
          - ip: "158.222.102.93"
            nic_uuid: "{{ ionos_cloud_nic.nic.id }}"
        wait: true
        state: update

    - name: Debug - Show LAN
      debug:
        msg: "{{ ionos_cloud_lan }}"

    - name: Remove NIC
      nic:
        name: "{{ ionos_cloud_nic.nic.id }}"
        datacenter: "{{ datacenter }}"
        server: "{{ server }}"
        wait: true
        wait_timeout: "{{ timeout }}"
        state: absent

    - name: Remove LAN
      lan:
        datacenter: "{{ name }}"
        name: "{{ lan }}"
        state: absent

    - name: Remove datacenter
      datacenter:
        name: "Ansible Test"
        state: absent